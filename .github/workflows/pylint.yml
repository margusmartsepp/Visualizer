name: Pylint and Tests

on: [push]

permissions:
  contents: write  # This grants write access for the workflow to push changes

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
      env:
        FORCE_JAVASCRIPT_ACTIONS_TO_NODE20: true
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint pytest
    - name: Run Linter and Tests
      run: |
        # Run pylint
        $lint_score = $(pylint $(git ls-files '*.py') | Select-String "Your code has been rated at" | ForEach-Object { $_.Line -replace '.+ rated at ', '' -replace '/10.+', '' })
        $lint_score_value = [double]($lint_score -replace '/10', '')

        # Set color for linter badge
        if ($lint_score_value -ge 8) {
          $lint_color = 'brightgreen'
        } elseif ($lint_score_value -ge 6) {
          $lint_color = 'yellow'
        } else {
          $lint_color = 'red'
        }

        # Create Linter Badge
        $lint_badge = "[![Linter](https://img.shields.io/badge/Linter-$lint_score_value%20/10-$lint_color)](https://github.com/margusmartsepp/Visualizer/actions)"
        Set-Content -Path 'linter-badge.md' -Value $lint_badge

        # Run tests
        pytest --maxfail=1 --disable-warnings > pytest_results.txt
        $test_results = Get-Content pytest_results.txt | Select-String -Pattern "^=+ (\d+) passed"
        $test_results_value = $test_results -replace '.+ (\d+) passed.+', '$1'

        # Set color for test badge
        if ($test_results_value -gt 0) {
          $test_color = 'brightgreen'
        } else {
          $test_color = 'red'
        }

        # Create Test Badge
        $test_badge = "[![Tests](https://img.shields.io/badge/Tests-$test_results_value%20passed-$test_color)](https://github.com/margusmartsepp/Visualizer/actions)"
        Set-Content -Path 'test-badge.md' -Value $test_badge
    - name: Commit and push badges
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add linter-badge.md test-badge.md
        git commit -m "Update badges"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
